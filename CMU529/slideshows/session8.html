<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session 8: Session Management & User Authentication</title>
    <link rel="stylesheet" href="../../libs/reveal.js/dist/reset.css">
    <link rel="stylesheet" href="../../libs/reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="../../placeholder/academic-theme.css">
    
    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="../../libs/reveal.js/plugin/highlight/monokai.css">
    <style>
        .reveal .slides section {
            text-align: left;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            max-height: 100vh;
        }
        .reveal .slides section h1 { font-size: 2.5em; margin-bottom: 0.5em; }
        .reveal .slides section h2 { font-size: 2em; margin-bottom: 0.5em; }
        .reveal .slides section h3 { font-size: 1.5em; margin-bottom: 0.5em; }
        .reveal .slides section p { font-size: 1.1em; line-height: 1.4; margin-bottom: 0.8em; }
        .reveal .slides section ul, .reveal .slides section ol { font-size: 1em; line-height: 1.4; margin-bottom: 0.8em; }
        .reveal .slides section li { margin-bottom: 0.3em; }
        .task-box {
            background: #fff5f5;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 60vh;
            overflow-y: auto;
        }
        .code-example {
            margin: 10px 0;
            max-width: 100%;
            overflow: visible;
        }

        .code-example pre {
            margin: 0;
        }
        .highlight {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
        .timeline-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
        }
        .timeline-info ul { margin: 10px 0; padding-left: 20px; }
        .timeline-info li { margin-bottom: 0.2em; }
        .diagram {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        @media (max-width: 768px) {
            .reveal .slides section { padding: 15px; }
            .reveal .slides section h1 { font-size: 2em; }
            .reveal .slides section h2 { font-size: 1.6em; }
            .reveal .slides section h3 { font-size: 1.3em; }
            .task-box, .code-example { font-size: 0.9em; padding: 15px; }
        }
        
        /* Custom scrollbar styling */
        .reveal .slides section::-webkit-scrollbar,
        .task-box::-webkit-scrollbar,
        .reveal .slides section::-webkit-scrollbar-track,
        .task-box::-webkit-scrollbar-track,
        .reveal .slides section::-webkit-scrollbar-thumb,
        .task-box::-webkit-scrollbar-thumb,
        .reveal .slides section::-webkit-scrollbar-thumb:hover,
        .task-box::-webkit-scrollbar-thumb:hover,
        </style>
</head>
<body>
            <div class="slide-nav">
        <a href="../../index.html" title="Home">H</a>
        <a href="../index.html" title="Module Home">M</a>
        <a href="session7.html" title="Previous Session">&lt;</a>
        <a href="session9.html" title="Next Session">&gt;</a>
    </div>
    
    <div class="reveal">
        <div class="slides">
            <!-- Slide 1: Title -->
            <section class="title-slide">
                <div class="module-code">CMU529: Advanced Web Development - Session 8</div>
                <h1>Session Management & User Authentication</h1>
                <h2>Full-stack Web Development with PHP and MySQL</h2>
                <div class="author">
                    <p><strong>James Williams</strong></p>
                    <p>Birmingham Newman University</p>
                    <p class="text-muted">jwilliams@staff.newman.ac.uk</p>
                    <p class="text-muted">3-hour session</p>
                </div>
            </section>

            

            <!-- Slide 2: Learning Objectives -->
            <section data-slide-title="Learning Objectives"><h2>Learning Objectives</h2>
                <ul>
                    <li>Implement user registration and login systems</li>
                    <li>Manage user sessions securely</li>
                    <li>Create authentication and authorization</li>
                    <li>Handle password security and recovery</li>
                    <li>Build protected user areas</li>
                </ul>
            </section>

            <!-- Slide 3: Session Basics -->
            <section data-slide-title="Session Basics"><h2>Session Basics</h2>
                <div class="code-example">
                <pre><code class="language-php">Starting Sessions:
&lt;?php
// Start session at beginning of script
session_start();
// Store data in session
$_SESSION['user_id'] = 123;
$_SESSION['username'] = 'john_doe';
$_SESSION['logged_in'] = true;
// Access session data
echo "Welcome " . $_SESSION['username'];
?&gt;</code></pre>
            </div>
                <ul>
                    <li>Sessions store data on server</li>
                    <li>Session ID stored in browser cookie</li>
                    <li>Data persists across page requests</li>
                </ul>
            </section>

            <!-- Slide 4: User Registration -->
            <section data-slide-title="User Registration"><h2>User Registration</h2>
                <div class="code-example">
                <pre><code class="language-php">Registration Process:
if ($_SERVER["REQUEST_METHOD"] == "POST") {
  $username = trim($_POST['username']);
  $email = trim($_POST['email']);
  $password = $_POST['password'];
  // Hash password
  $hashedPassword = password_hash($password, PASSWORD_DEFAULT);
  // Insert user into database
  $stmt = $pdo-&gt;prepare("INSERT INTO users (username, email, password) VALUES (?, ?, ?)");
  $stmt-&gt;execute([$username, $email, $hashedPassword]);
  echo "Registration successful!";
}</code></pre>
            </div>
                <ul>
                    <li>Always hash passwords</li>
                    <li>Validate input data</li>
                    <li>Check for duplicate emails</li>
                </ul>
            </section>

            <!-- Slide 5: User Login -->
            <section data-slide-title="User Login"><h2>User Login</h2>
                <div class="code-example">
                <pre><code class="language-php">Login Verification:
function authenticateUser($email, $password) {
  global $pdo;
  $stmt = $pdo-&gt;prepare("SELECT id, username, password FROM users WHERE email = ?");
  $stmt-&gt;execute([$email]);
  $user = $stmt-&gt;fetch();
  if ($user &amp;&amp; password_verify($password, $user['password'])) {
    $_SESSION['user_id'] = $user['id'];
    $_SESSION['username'] = $user['username'];
    $_SESSION['logged_in'] = true;
    return true;
  }
  return false;
}</code></pre>
            </div>
                <ul>
                    <li>Use password_verify() for comparison</li>
                    <li>Store user data in session</li>
                    <li>Return boolean for success/failure</li>
                </ul>
            </section>

            <!-- Slide 6: Session Management -->
            <section data-slide-title="Session Management"><h2>Session Management</h2>
                <div class="code-example">
                <pre><code class="language-php">Session Functions:
// Check if user is logged in
function isLoggedIn() {
  return isset($_SESSION['logged_in']) &amp;&amp; $_SESSION['logged_in'] === true;
}
// Logout function
function logout() {
  session_start();
  session_destroy();
  header("Location: login.php");
  exit();
}
// Protect pages
if (!isLoggedIn()) {
  header("Location: login.php");
  exit();
}</code></pre>
            </div>
                <ul>
                    <li>Check login status on protected pages</li>
                    <li>Destroy session on logout</li>
                    <li>Redirect unauthorized users</li>
                </ul>
            </section>

            <!-- Slide 7: Password Security -->
            <section data-slide-title="Password Security"><h2>Password Security</h2>
                <div class="code-example">
                <pre><code class="language-php">Password Validation:
function validatePassword($password) {
  $errors = [];
  if (strlen($password) &lt; 8) {
    $errors[] = "Password must be at least 8 characters";
  }
  if (!preg_match("/[A-Z]/", $password)) {
    $errors[] = "Password must contain uppercase letter";
  }
  if (!preg_match("/[0-9]/", $password)) {
    $errors[] = "Password must contain number";
  }
  return $errors;
}</code></pre>
            </div>
                <ul>
                    <li>Enforce strong password requirements</li>
                    <li>Use regex for pattern matching</li>
                    <li>Return array of validation errors</li>
                </ul>
            </section>

            <!-- Slide 8: Password Reset -->
            <section data-slide-title="Password Reset"><h2>Password Reset</h2>
                <div class="code-example">
                <pre><code class="language-php">Reset Token System:
// Generate reset token
$token = bin2hex(random_bytes(32));
$expires = date('Y-m-d H:i:s', strtotime('+1 hour'));
// Store token in database
$stmt = $pdo-&gt;prepare("INSERT INTO password_resets (email, token, expires) VALUES (?, ?, ?)");
$stmt-&gt;execute([$email, $token, $expires]);
// Send email with reset link
$resetLink = "https://example.com/reset.php?token=" . $token;
mail($email, "Password Reset", "Click here to reset: " . $resetLink);
// Verify token
$stmt = $pdo-&gt;prepare("SELECT * FROM password_resets WHERE token = ? AND expires &gt; NOW()");
$stmt-&gt;execute([$token]);
$reset = $stmt-&gt;fetch();</code></pre>
            </div>
                <ul>
                    <li>Generate secure random tokens</li>
                    <li>Set expiration times</li>
                    <li>Send reset links via email</li>
                </ul>
            </section>

            <!-- Slide 9: User Profiles -->
            <section data-slide-title="User Profiles"><h2>User Profiles</h2>
                <div class="code-example">
                <pre><code class="language-php">Profile Management:
// Get user profile
$userId = $_SESSION['user_id'];
$stmt = $pdo-&gt;prepare("SELECT * FROM users WHERE id = ?");
$stmt-&gt;execute([$userId]);
$user = $stmt-&gt;fetch();
// Update profile
if ($_SERVER["REQUEST_METHOD"] == "POST") {
  $firstName = trim($_POST['first_name']);
  $lastName = trim($_POST['last_name']);
  $phone = trim($_POST['phone']);
  $stmt = $pdo-&gt;prepare("UPDATE users SET first_name = ?, last_name = ?, phone = ? WHERE id = ?");
  $stmt-&gt;execute([$firstName, $lastName, $phone, $userId]);
  echo "Profile updated successfully";
}</code></pre>
            </div>
                <ul>
                    <li>Display user information</li>
                    <li>Allow profile updates</li>
                    <li>Validate input data</li>
                </ul>
            </section>

            <!-- Slide 10: Authorization -->
            <section data-slide-title="Authorization"><h2>Authorization</h2>
                <div class="code-example">
                <pre><code class="language-php">Role-Based Access:
// Check user role
function hasRole($role) {
  global $pdo;
  $userId = $_SESSION['user_id'];
  $stmt = $pdo-&gt;prepare("SELECT role FROM users WHERE id = ?");
  $stmt-&gt;execute([$userId]);
  $user = $stmt-&gt;fetch();
  return $user['role'] === $role;
}
// Protect admin pages
if (!hasRole('admin')) {
  header("Location: access-denied.php");
  exit();
}</code></pre>
            </div>
                <ul>
                    <li>Check user permissions</li>
                    <li>Restrict access to features</li>
                    <li>Redirect unauthorized users</li>
                </ul>
            </section>

            <!-- Slide 11: TASK 1 - Halfway Point -->
            <section data-slide-title="Task 1: User Authentication System" class="center"><h2>Task 1: User Authentication System</h2>
                <div class="task-box">
                    <h3>Instructions:</h3>
                    <ol>
                        <li>Create a complete user authentication system with:</li>
                        <ul>
                            <li>User registration form with validation</li>
                            <li>Login form with authentication</li>
                            <li>Session management and security</li>
                            <li>Password reset functionality</li>
                            <li>User profile management</li>
                        </ul>
                        <li>Implement password security measures</li>
                        <li>Add CSRF protection</li>
                        <li>Create protected user areas</li>
                        <li>Test all authentication flows</li>
                    </ol>
                    <p><strong>Time:</strong> 45 minutes</p>
                    <p><em>This task will help you master user authentication and session management</em></p>
                </div>
            </section>

            <!-- Slide 12: Break/Catch Up -->
            <section data-slide-title="Break Time" class="center"><h2>Break Time</h2>
                <div class="highlight">
                    <h3>15 Minutes</h3>
                    <p>Take a break, ask questions, or catch up on the previous task.</p>
                    <p><em>Next: Secondary slides and Task 2</em></p>
                </div>
            </section>

            <!-- Slide 13: Remember Me -->
            <section data-slide-title="Remember Me Functionality"><h2>Remember Me Functionality</h2>
                <div class="code-example">
                <pre><code class="language-php">Persistent Login:
// Set remember me cookie
if (isset($_POST['remember_me'])) {
  $token = bin2hex(random_bytes(32));
  $expires = time() + (30 * 24 * 60 * 60); // 30 days
  // Store token in database
  $stmt = $pdo-&gt;prepare("INSERT INTO remember_tokens (user_id, token, expires) VALUES (?, ?, ?)");
  $stmt-&gt;execute([$userId, $token, date('Y-m-d H:i:s', $expires)]);
  // Set cookie
  setcookie('remember_token', $token, $expires, '/', '', true, true);
}
// Check remember me token
if (isset($_COOKIE['remember_token'])) {
  $token = $_COOKIE['remember_token'];
  $stmt = $pdo-&gt;prepare("SELECT user_id FROM remember_tokens WHERE token = ? AND expires &gt; NOW()");
  $stmt-&gt;execute([$token]);
  $result = $stmt-&gt;fetch();
  if ($result) {
    $_SESSION['user_id'] = $result['user_id'];
    $_SESSION['logged_in'] = true;
  }
}</code></pre>
            </div>
            </section>

            <!-- Slide 14: Session Security -->
            <section data-slide-title="Session Security"><h2>Session Security</h2>
                <div class="code-example">
                <pre><code class="language-php">Security Measures:
// Secure session configuration
ini_set('session.cookie_httponly', 1);
ini_set('session.cookie_secure', 1);
ini_set('session.use_strict_mode', 1);
// Regenerate session ID
if (!isset($_SESSION['initialized'])) {
  session_regenerate_id(true);
  $_SESSION['initialized'] = true;
}
// Check session timeout
if (isset($_SESSION['last_activity']) &amp;&amp; (time() - $_SESSION['last_activity'] &gt; 1800)) {
  session_unset();
  session_destroy();
  header("Location: login.php");
  exit();
}
$_SESSION['last_activity'] = time();</code></pre>
            </div>
            </section>

            <!-- Slide 15: Two-Factor Authentication -->
            <section data-slide-title="Two-Factor Authentication"><h2>Two-Factor Authentication</h2>
                <div class="code-example">
                <pre><code class="language-php">SMS Verification:
// Generate verification code
$verificationCode = sprintf("%06d", mt_rand(0, 999999));
$_SESSION['verification_code'] = $verificationCode;
$_SESSION['verification_time'] = time();
// Send SMS (mock implementation)
$message = "Your verification code is: " . $verificationCode;
// sendSMS($phone, $message);
// Verify code
if (isset($_POST['verification_code'])) {
  $inputCode = $_POST['verification_code'];
  $storedCode = $_SESSION['verification_code'];
  $verificationTime = $_SESSION['verification_time'];
  if ($inputCode === $storedCode &amp;&amp; (time() - $verificationTime) &lt; 300) {
    $_SESSION['two_factor_verified'] = true;
    echo "Verification successful";
  } else {
    echo "Invalid or expired code";
  }
}</code></pre>
            </div>
            </section>

            <!-- Slide 16: Account Lockout -->
            <section data-slide-title="Account Lockout"><h2>Account Lockout</h2>
                <div class="code-example">
                <pre><code class="language-php">Failed Login Protection:
// Track failed login attempts
function recordFailedLogin($email) {
  global $pdo;
  $stmt = $pdo-&gt;prepare("INSERT INTO failed_logins (email, ip_address, timestamp) VALUES (?, ?, NOW())");
  $stmt-&gt;execute([$email, $_SERVER['REMOTE_ADDR']]);
}
// Check if account is locked
function isAccountLocked($email) {
  global $pdo;
  $stmt = $pdo-&gt;prepare("SELECT COUNT(*) FROM failed_logins WHERE email = ? AND timestamp &gt; DATE_SUB(NOW(), INTERVAL 15 MINUTE)");
  $stmt-&gt;execute([$email]);
  $failedAttempts = $stmt-&gt;fetchColumn();
  return $failedAttempts &gt;= 5;
}
// Check before login
if (isAccountLocked($email)) {
  echo "Account temporarily locked. Try again in 15 minutes.";
  exit();
}</code></pre>
            </div>
            </section>

            <!-- Slide 17: User Activity Logging -->
            <section data-slide-title="User Activity Logging"><h2>User Activity Logging</h2>
                <div class="code-example">
                <pre><code class="language-php">Activity Tracking:
function logUserActivity($userId, $action, $details = '') {
  global $pdo;
  $stmt = $pdo-&gt;prepare("INSERT INTO user_activity (user_id, action, details, ip_address, timestamp) VALUES (?, ?, ?, ?, NOW())");
  $stmt-&gt;execute([$userId, $action, $details, $_SERVER['REMOTE_ADDR']]);
}
// Log login
logUserActivity($userId, 'login', 'User logged in successfully');
// Log profile update
logUserActivity($userId, 'profile_update', 'Updated personal information');
// Log password change
logUserActivity($userId, 'password_change', 'Password changed successfully');
// Get user activity
$stmt = $pdo-&gt;prepare("SELECT * FROM user_activity WHERE user_id = ? ORDER BY timestamp DESC LIMIT 10");
$stmt-&gt;execute([$userId]);
$activities = $stmt-&gt;fetchAll();</code></pre>
            </div>
            </section>

            <!-- Slide 18: Social Login -->
            <section data-slide-title="Social Login Integration"><h2>Social Login Integration</h2>
                <div class="code-example">
                <pre><code class="language-php">OAuth Implementation:
// Google OAuth callback
if (isset($_GET['code'])) {
  $code = $_GET['code'];
  $clientId = 'your_google_client_id';
  $clientSecret = 'your_google_client_secret';
  // Exchange code for token
  $tokenUrl = 'https://oauth2.googleapis.com/token';
  $data = [
    'code' =&gt; $code,
    'client_id' =&gt; $clientId,
    'client_secret' =&gt; $clientSecret,
    'redirect_uri' =&gt; 'https://yoursite.com/callback.php',
    'grant_type' =&gt; 'authorization_code'
  ];
  // Get user info from Google
  $userInfo = getUserInfoFromGoogle($accessToken);
  // Create or login user
  handleSocialLogin($userInfo);
}</code></pre>
            </div>
            </section>

            <!-- Slide 19: Email Verification -->
            <section data-slide-title="Email Verification"><h2>Email Verification</h2>
                <div class="code-example">
                <pre><code class="language-php">Email Confirmation:
// Generate verification token
$verificationToken = bin2hex(random_bytes(32));
$stmt = $pdo-&gt;prepare("UPDATE users SET email_verified = 0, verification_token = ? WHERE id = ?");
$stmt-&gt;execute([$verificationToken, $userId]);
// Send verification email
$verificationLink = "https://example.com/verify.php?token=" . $verificationToken;
$to = $email;
$subject = "Verify Your Email Address";
$message = "Click the following link to verify your email: " . $verificationLink;
$headers = "From: noreply@example.com";
mail($to, $subject, $message, $headers);
// Verify email
if (isset($_GET['token'])) {
  $token = $_GET['token'];
  $stmt = $pdo-&gt;prepare("UPDATE users SET email_verified = 1, verification_token = NULL WHERE verification_token = ?");
  $stmt-&gt;execute([$token]);
  if ($stmt-&gt;rowCount() &gt; 0) {
    echo "Email verified successfully";
  }
}</code></pre>
            </div>
            </section>

            <!-- Slide 20: Session Hijacking Protection -->
            <section data-slide-title="Session Hijacking Protection"><h2>Session Hijacking Protection</h2>
                <div class="code-example">
                <pre><code class="language-php">Security Measures:
// Store user agent in session
if (!isset($_SESSION['user_agent'])) {
  $_SESSION['user_agent'] = $_SERVER['HTTP_USER_AGENT'];
}
// Check for session hijacking
if ($_SESSION['user_agent'] !== $_SERVER['HTTP_USER_AGENT']) {
  session_unset();
  session_destroy();
  header("Location: login.php?error=hijacking");
  exit();
}
// Store IP address
if (!isset($_SESSION['ip_address'])) {
  $_SESSION['ip_address'] = $_SERVER['REMOTE_ADDR'];
}
// Check IP changes
if ($_SESSION['ip_address'] !== $_SERVER['REMOTE_ADDR']) {
  session_unset();
  session_destroy();
  header("Location: login.php?error=ip_change");
  exit();
}</code></pre>
            </div>
            </section>

            <!-- Slide 21: TASK 2 - Final Task -->
            <section data-slide-title="Task 2: Advanced Authentication System" class="center"><h2>Task 2: Advanced Authentication System</h2>
                <div class="task-box">
                    <h3>Instructions:</h3>
                    <ol>
                        <li>Build an advanced authentication system with:</li>
                        <ul>
                            <li>Two-factor authentication (SMS/Email)</li>
                            <li>Remember me functionality</li>
                            <li>Account lockout protection</li>
                            <li>User activity logging</li>
                            <li>Email verification system</li>
                            <li>Social login integration</li>
                        </ul>
                        <li>Implement session security measures</li>
                        <li>Add comprehensive error handling</li>
                        <li>Create admin user management</li>
                        <li>Test all security features</li>
                    </ol>
                    <p><strong>Time:</strong> 45 minutes</p>
                    <p><em>This task will help you build a professional authentication system</em></p>
                </div>
            </section>

            <!-- Slide 22: Summary -->
            <section data-slide-title="Session Summary" class="center"><h2>Session Summary</h2>
                <ul>
                    <li>User authentication is essential for web applications</li>
                    <li>Session management maintains user state</li>
                    <li>Password security protects user accounts</li>
                    <li>Two-factor authentication adds extra security</li>
                    <li>Account lockout prevents brute force attacks</li>
                    <li>Activity logging helps monitor user behavior</li>
                    <li>Email verification ensures valid user accounts</li>
                    <li>Social login provides convenient authentication</li>
                </ul>
                <div class="highlight">
                    <h3>Next Session:</h3>
                    <p>E-commerce Core Features - Product catalogues, shopping cart, and order management</p>
                </div>
            </section>
        </div>
    </div>

    <script src="../../libs/reveal.js/dist/reveal.js"></script>
    <script src="../../libs/reveal.js/plugin/notes/notes.js"></script>
    <script src="../../libs/reveal.js/plugin/markdown/markdown.js"></script>
    <script src="../../libs/reveal.js/plugin/highlight/highlight.js"></script>
    <script>
        
        // Prevent wheel events from changing slides when scrolling within scrollable content
        document.addEventListener('DOMContentLoaded', function() {
            const scrollableElements = document.querySelectorAll('.reveal pre, .reveal .code-example, .reveal .task-box, .reveal .info-box, .reveal .warning-box, [style*="overflow"]');
            
            scrollableElements.forEach(function(element) {
                element.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            });
        });
        Reveal.initialize({
            hash: true,
            slideNumber: true,
            transition: 'none',
            backgroundTransition: 'none',
            center: false,
            disableLayout: true,
            plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
        });
    </script>
</body>
</html>
