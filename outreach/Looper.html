<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Looper: Algorithm Architect | Interactive CS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Roboto:wght@700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
        }

        /* IDE Styling */
        .ide-panel {
            background-color: #1e293b;
            box-shadow: inset 5px 0 10px rgba(0, 0, 0, 0.2);
        }

        .code-line {
            counter-increment: line;
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-bottom: 1px solid #334155;
            cursor: grab;
            transition: background 0.1s;
        }

        .code-line:active {
            cursor: grabbing;
        }

        .code-line:hover {
            background-color: #334155;
        }

        .code-line::before {
            content: counter(line);
            color: #64748b;
            font-size: 0.8em;
            width: 20px;
            text-align: right;
            margin-right: 12px;
        }

        .code-line.active-exec {
            background-color: #3730a3;
            /* Indigo 800 */
            border-left: 4px solid #818cf8;
        }

        .code-line.indent-1 {
            padding-left: 30px;
        }

        .code-line.indent-2 {
            padding-left: 50px;
        }

        .code-line.indent-3 {
            padding-left: 70px;
        }

        /* Drag & Drop Styles */
        .code-line.dragging {
            opacity: 0.5;
            background: #475569;
            border: 1px dashed #94a3b8;
        }

        .code-line.drag-over-top {
            border-top: 2px solid #818cf8;
        }

        .code-line.drag-over-bottom {
            border-bottom: 2px solid #818cf8;
        }

        .cmd-token {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            pointer-events: none;
        }

        .cmd-move {
            background: #059669;
            color: white;
        }

        /* Emerald */
        .cmd-turn {
            background: #0284c7;
            color: white;
        }

        /* Sky */
        .cmd-collect {
            background: #d97706;
            color: white;
        }

        /* Amber */
        .cmd-loop {
            background: #9333ea;
            color: white;
        }

        /* Purple */
        .cmd-end {
            background: #475569;
            color: #94a3b8;
        }

        /* Slate */

        /* Grid */
        #gridCanvas {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        .jw-logo {
            font-family: 'Roboto', sans-serif;
            letter-spacing: -1px;
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col md:flex-row">

    <!-- GAME AREA (Left) -->
    <div class="relative flex-1 bg-slate-900 flex flex-col items-center justify-center p-4">

        <!-- Header HUD -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-10">
            <button id="jwBtn"
                class="flex items-center justify-center w-10 h-10 bg-indigo-600 rounded-md shadow-lg hover:bg-indigo-700 transition-colors group">
                <div class="flex font-bold text-white text-sm jw-logo">
                    <span>J</span>
                    <span class="text-indigo-200 group-hover:text-white transition-colors">W</span>
                </div>
            </button>
            <div class="flex gap-6">
                <div class="text-center">
                    <div class="text-xs text-slate-400 uppercase">Level</div>
                    <div class="text-xl font-bold text-white" id="levelDisplay">1</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-slate-400 uppercase">Memory</div>
                    <div class="text-xl font-bold text-indigo-400"><span id="ramUsage">0</span>/<span
                            id="ramMax">10</span></div>
                </div>
            </div>
        </div>

        <!-- The Grid -->
        <canvas id="gridCanvas" class="bg-slate-800 border border-slate-700"></canvas>

        <!-- Playback Controls -->
        <div class="mt-6 flex gap-4">
            <button id="runBtn"
                class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                <i class="fa-solid fa-play"></i> RUN CODE
            </button>

            <button id="resetBotBtn"
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded font-bold shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                <i class="fa-solid fa-rotate-left"></i> RESET BOT
            </button>

            <button id="stopBtn"
                class="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded font-bold shadow-lg flex items-center gap-2 transition-transform active:scale-95 hidden">
                <i class="fa-solid fa-stop"></i> STOP
            </button>

            <button id="stepBtn"
                class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded font-bold shadow-lg transition-transform active:scale-95">
                <i class="fa-solid fa-forward-step"></i>
            </button>
        </div>
    </div>

    <!-- IDE PANEL (Right) -->
    <div
        class="w-full md:w-96 h-1/2 md:h-full flex flex-col ide-panel border-t md:border-t-0 md:border-l border-slate-700 z-20">

        <!-- Code Editor Header -->
        <div class="bg-slate-800 p-3 border-b border-slate-700 flex justify-between items-center">
            <span class="text-sm font-bold text-slate-300 flex items-center gap-2">
                <i class="fa-solid fa-code"></i> main.algo
            </span>
            <button id="clearBtn" class="text-xs text-red-400 hover:text-red-300 uppercase font-bold">
                Clear All
            </button>
        </div>

        <!-- Code List (Droppable Area) -->
        <div id="codeContainer" class="flex-1 overflow-y-auto bg-slate-900/50 p-2 space-y-1">
            <div class="text-slate-600 text-center mt-10 text-sm italic empty-msg">
                // Drag commands here or click to add
            </div>
        </div>

        <!-- Command Palette -->
        <div class="bg-slate-800 p-4 border-t border-slate-700">
            <div class="text-xs text-slate-500 uppercase font-bold mb-2">Instruction Set</div>
            <div class="grid grid-cols-3 gap-2">
                <button class="cmd-btn bg-emerald-700 hover:bg-emerald-600 text-white p-2 rounded text-xs font-bold"
                    data-cmd="MOVE">
                    MOVE
                </button>
                <button class="cmd-btn bg-sky-700 hover:bg-sky-600 text-white p-2 rounded text-xs font-bold"
                    data-cmd="TURN_LEFT">
                    TURN L
                </button>
                <button class="cmd-btn bg-sky-700 hover:bg-sky-600 text-white p-2 rounded text-xs font-bold"
                    data-cmd="TURN_RIGHT">
                    TURN R
                </button>
                <button class="cmd-btn bg-amber-700 hover:bg-amber-600 text-white p-2 rounded text-xs font-bold"
                    data-cmd="COLLECT">
                    GET DATA
                </button>
                <button
                    class="cmd-btn bg-purple-700 hover:bg-purple-600 text-white p-2 rounded text-xs font-bold col-span-2"
                    data-cmd="LOOP">
                    REPEAT...
                </button>
            </div>
            <div class="mt-2 text-[10px] text-slate-500 text-center">
                Tip: Loops save RAM. Use them for repeating patterns.
            </div>
            <div class="mt-4 text-[10px] text-slate-600 text-center border-t border-slate-700 pt-2">
                Made by James Williams. MIT Licensed.
            </div>
        </div>
    </div>

    <!-- LEVEL COMPLETE MODAL -->
    <div id="successModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div
            class="bg-slate-800 border border-indigo-500 rounded-lg p-8 max-w-sm w-full text-center shadow-2xl transform transition-all scale-100">
            <div
                class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-green-500/50">
                <i class="fa-solid fa-check text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">OPTIMIZATION COMPLETE</h2>
            <p class="text-slate-400 mb-6">Algorithm efficiency: <span class="text-indigo-400 font-bold">100%</span></p>
            <button id="nextLevelBtn"
                class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded w-full transition-transform hover:scale-105">
                NEXT PROTOCOL
            </button>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const TILE_SIZE = 50;
        const GRID_COLORS = {
            bg: '#1e293b',
            line: '#334155',
            wall: '#475569',
            start: '#059669',
            end: '#0ea5e9'
        };

        // --- LEVEL DATA (10 LEVELS) ---
        const LEVELS = [
            {
                id: 1,
                name: "Linear Sequence",
                gridW: 6,
                gridH: 1,
                map: [2, 0, 0, 0, 3, 0],
                maxRam: 5,
                hint: "Just move forward."
            },
            {
                id: 2,
                name: "The Spiral",
                gridW: 5,
                gridH: 5,
                map: [
                    2, 0, 0, 0, 0,
                    1, 1, 1, 1, 0,
                    1, 1, 1, 1, 0,
                    1, 1, 1, 1, 0,
                    3, 0, 0, 0, 0
                ],
                startDir: 1,
                maxRam: 10,
                hint: "Pattern: Move forward, Turn Right."
            },
            {
                id: 3,
                name: "Loop Basic",
                gridW: 6,
                gridH: 6,
                map: [
                    2, 0, 0, 0, 0, 3,
                    1, 1, 1, 1, 1, 1,
                    0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0,
                    0, 0, 0, 0, 0, 0
                ],
                maxRam: 4,
                hint: "Not enough memory to write MOVE 5 times. Use REPEAT."
            },
            {
                id: 4,
                name: "Zig Zag",
                gridW: 5,
                gridH: 5,
                // Fixed map to actually allow zig zagging
                map: [
                    2, 0, 1, 0, 0,
                    1, 0, 1, 0, 1,
                    0, 0, 1, 0, 3,
                    0, 1, 1, 0, 1,
                    0, 0, 0, 0, 0
                ],
                maxRam: 8,
                hint: "Move, Turn R, Move, Turn L..."
            },
            {
                id: 5,
                name: "The Box",
                gridW: 4,
                gridH: 4,
                map: [
                    2, 0, 0, 0,
                    0, 1, 1, 0,
                    0, 1, 1, 0,
                    0, 0, 0, 3
                ],
                startDir: 1,
                maxRam: 8,
                hint: "Go around the center obstacle. The path is symmetric."
            },
            {
                id: 6,
                name: "Stairway",
                gridW: 6,
                gridH: 6,
                map: [
                    0, 0, 0, 0, 0, 3,
                    0, 0, 0, 0, 1, 0,
                    0, 0, 0, 1, 0, 0,
                    0, 0, 1, 0, 0, 0,
                    0, 1, 0, 0, 0, 0,
                    2, 0, 0, 0, 0, 0
                ],
                startDir: 0, // Facing North
                maxRam: 10, // Increased RAM (Pattern is Move, Turn, Move, Turn = 4 lines inside loop)
                hint: "Climb the stairs using a repeating pattern."
            },
            {
                id: 7,
                name: "Patrol",
                gridW: 5,
                gridH: 1,
                map: [2, 0, 3, 0, 3], // Two items
                maxRam: 10,
                hint: "Move, Collect, Move, Move, Collect."
            },
            {
                id: 8,
                name: "The U-Turn",
                gridW: 4,
                gridH: 3,
                map: [
                    2, 1, 3, 0,
                    0, 1, 0, 1,
                    0, 0, 0, 1
                ],
                startDir: 2, // South
                maxRam: 12,
                hint: "Navigate the U-shape."
            },
            {
                id: 9,
                name: "Loopception",
                gridW: 7,
                gridH: 7,
                map: [
                    2, 0, 0, 0, 0, 0, 0,
                    1, 1, 1, 1, 1, 1, 0,
                    0, 0, 0, 0, 0, 1, 0,
                    0, 1, 1, 1, 0, 1, 0,
                    0, 1, 3, 1, 0, 1, 0,
                    0, 1, 0, 0, 0, 1, 0,
                    0, 1, 1, 1, 1, 1, 0
                ],
                maxRam: 20, // Increased RAM to allow unrolled loops for diminishing spiral
                hint: "A long spiral inward. Look for long straight segments."
            },
            {
                id: 10,
                name: "The Grid",
                gridW: 5,
                gridH: 5,
                map: [
                    2, 3, 0, 3, 0,
                    0, 1, 0, 1, 0,
                    0, 0, 0, 0, 0,
                    0, 1, 0, 1, 0,
                    0, 3, 0, 3, 0
                ],
                maxRam: 25,
                hint: "Collect all 4 cores. Plan a route that visits corners."
            }
        ];

        // --- STATE ---
        let currentLevelIdx = 0;
        let program = [];
        let isRunning = false;
        let pc = 0;
        let executionStack = [];
        let bot = { x: 0, y: 0, dir: 1 };
        let coresCollected = 0;
        let totalCores = 0;
        let speed = 500;
        let draggedItemIndex = null;
        let collectedCoords = [];

        const canvas = document.getElementById('gridCanvas');
        const ctx = canvas.getContext('2d');

        // --- INITIALIZATION ---
        function initLevel(idx) {
            currentLevelIdx = idx;
            const lvl = LEVELS[idx];

            canvas.width = lvl.gridW * TILE_SIZE;
            canvas.height = lvl.gridH * TILE_SIZE;

            resetBotState();

            totalCores = lvl.map.filter(x => x === 3).length;

            document.getElementById('levelDisplay').innerText = lvl.id;
            document.getElementById('ramMax').innerText = lvl.maxRam;
            updateRamUsage();

            program = [];
            renderIDE();
            drawGame();

            setUIState('idle');
            document.getElementById('successModal').classList.add('hidden');
        }

        function resetBotState() {
            const lvl = LEVELS[currentLevelIdx];
            const startIdx = lvl.map.indexOf(2);
            bot.x = startIdx % lvl.gridW;
            bot.y = Math.floor(startIdx / lvl.gridW);
            bot.dir = lvl.startDir !== undefined ? lvl.startDir : 1;
            coresCollected = 0;
            collectedCoords = [];
        }

        function setUIState(state) {
            const runBtn = document.getElementById('runBtn');
            const stopBtn = document.getElementById('stopBtn');
            const resetBtn = document.getElementById('resetBotBtn');
            const stepBtn = document.getElementById('stepBtn');

            if (state === 'running') {
                runBtn.classList.add('hidden');
                resetBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                stepBtn.disabled = true;
                stepBtn.classList.add('opacity-50');
            } else {
                runBtn.classList.remove('hidden');
                resetBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                stepBtn.disabled = false;
                stepBtn.classList.remove('opacity-50');
            }
        }

        // --- RENDERING ---
        function drawGame() {
            const lvl = LEVELS[currentLevelIdx];

            ctx.fillStyle = GRID_COLORS.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < lvl.gridH; y++) {
                for (let x = 0; x < lvl.gridW; x++) {
                    const cell = lvl.map[y * lvl.gridW + x];
                    const px = x * TILE_SIZE;
                    const py = y * TILE_SIZE;

                    ctx.strokeStyle = GRID_COLORS.line;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(px, py, TILE_SIZE, TILE_SIZE);

                    if (cell === 1) {
                        ctx.fillStyle = GRID_COLORS.wall;
                        ctx.fillRect(px + 2, py + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                    }
                    if (cell === 2) {
                        ctx.fillStyle = 'rgba(5, 150, 105, 0.2)';
                        ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    }
                    if (cell === 3) {
                        const isCollected = isCoreCollected(x, y);
                        if (!isCollected) {
                            ctx.fillStyle = '#f59e0b';
                            ctx.beginPath();
                            ctx.arc(px + TILE_SIZE / 2, py + TILE_SIZE / 2, 8, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.shadowBlur = 10;
                            ctx.shadowColor = '#f59e0b';
                            ctx.stroke();
                            ctx.shadowBlur = 0;
                        }
                    }
                }
            }
            drawBot();
        }

        function isCoreCollected(x, y) {
            return collectedCoords.some(c => c.x === x && c.y === y);
        }

        function drawBot() {
            const px = bot.x * TILE_SIZE + TILE_SIZE / 2;
            const py = bot.y * TILE_SIZE + TILE_SIZE / 2;

            ctx.save();
            ctx.translate(px, py);
            const rotation = (bot.dir - 1) * 90 * (Math.PI / 180);
            ctx.rotate(rotation);

            ctx.fillStyle = '#6366f1';
            ctx.beginPath();
            ctx.moveTo(15, 0);
            ctx.lineTo(-10, 10);
            ctx.lineTo(-10, -10);
            ctx.fill();

            ctx.fillStyle = '#4ade80';
            ctx.beginPath();
            ctx.arc(0, 0, 4, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        // --- IDE LOGIC ---
        function addCommand(type) {
            if (program.length >= LEVELS[currentLevelIdx].maxRam) {
                alert("Memory Full! Use Loops to optimize.");
                return;
            }

            const cmd = { id: Date.now(), type: type };
            if (type === 'LOOP') {
                cmd.count = 2;
                cmd.type = 'LOOP_START';
                program.push(cmd);
                program.push({ id: Date.now() + 1, type: 'LOOP_END' });
            } else {
                program.push(cmd);
            }

            renderIDE();
            updateRamUsage();
        }

        function deleteCommand(index) {
            program.splice(index, 1);
            renderIDE();
            updateRamUsage();
        }

        function updateLoopCount(index, change) {
            const cmd = program[index];
            if (cmd.type === 'LOOP_START') {
                cmd.count = Math.max(2, Math.min(9, cmd.count + change));
                renderIDE();
            }
        }

        function handleDragStart(e, index) {
            if (isRunning) { e.preventDefault(); return; }
            draggedItemIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', index);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const targetLine = e.target.closest('.code-line');
            if (targetLine && targetLine !== e.target) {
                const rect = targetLine.getBoundingClientRect();
                const offset = e.clientY - rect.top - (rect.height / 2);
                targetLine.classList.remove('drag-over-top', 'drag-over-bottom');
                if (offset < 0) targetLine.classList.add('drag-over-top');
                else targetLine.classList.add('drag-over-bottom');
            }
        }

        function handleDragLeave(e) {
            const targetLine = e.target.closest('.code-line');
            if (targetLine) targetLine.classList.remove('drag-over-top', 'drag-over-bottom');
        }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            const targetLine = e.target.closest('.code-line');
            if (targetLine) targetLine.classList.remove('drag-over-top', 'drag-over-bottom');

            if (draggedItemIndex === null || draggedItemIndex === targetIndex) return;

            const rect = targetLine.getBoundingClientRect();
            const offset = e.clientY - rect.top - (rect.height / 2);
            let newIndex = targetIndex;
            if (offset > 0) newIndex++;

            const item = program[draggedItemIndex];
            program.splice(draggedItemIndex, 1);
            if (draggedItemIndex < newIndex) newIndex--;
            program.splice(newIndex, 0, item);

            draggedItemIndex = null;
            renderIDE();
        }

        function renderIDE() {
            const container = document.getElementById('codeContainer');
            container.innerHTML = '';

            if (program.length === 0) {
                container.innerHTML = '<div class="text-slate-600 text-center mt-10 text-sm italic empty-msg">// Drag commands here or click to add</div>';
                return;
            }

            let indentLevel = 0;

            program.forEach((cmd, idx) => {
                const line = document.createElement('div');
                if (cmd.type === 'LOOP_END') indentLevel = Math.max(0, indentLevel - 1);

                line.className = `code-line indent-${indentLevel} group`;
                if (pc === idx && isRunning) line.classList.add('active-exec');

                line.draggable = true;
                line.ondragstart = (e) => handleDragStart(e, idx);
                line.ondragover = (e) => handleDragOver(e);
                line.ondrop = (e) => handleDrop(e, idx);
                line.ondragenter = (e) => handleDragEnter(e);
                line.ondragleave = (e) => handleDragLeave(e);

                let html = '';
                if (cmd.type === 'MOVE') html = `<span class="cmd-token cmd-move">MOVE_FWD</span>`;
                else if (cmd.type === 'TURN_LEFT') html = `<span class="cmd-token cmd-turn">ROTATE_L</span>`;
                else if (cmd.type === 'TURN_RIGHT') html = `<span class="cmd-token cmd-turn">ROTATE_R</span>`;
                else if (cmd.type === 'COLLECT') html = `<span class="cmd-token cmd-collect">GET_CORE</span>`;
                else if (cmd.type === 'LOOP_START') {
                    html = `
                        <span class="cmd-token cmd-loop">REPEAT</span>
                        <div class="flex items-center ml-2 bg-slate-700 rounded px-1" onmousedown="event.stopPropagation()">
                            <button class="text-xs px-1 hover:text-white text-slate-400" onclick="updateLoopCount(${idx}, -1)">-</button>
                            <span class="text-indigo-300 font-bold px-1">${cmd.count}</span>
                            <button class="text-xs px-1 hover:text-white text-slate-400" onclick="updateLoopCount(${idx}, 1)">+</button>
                        </div>
                    `;
                }
                else if (cmd.type === 'LOOP_END') html = `<span class="cmd-token cmd-end">END_LOOP</span>`;

                line.innerHTML = html;

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                delBtn.className = 'ml-auto text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity px-2';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteCommand(idx); };
                line.appendChild(delBtn);

                container.appendChild(line);
                if (cmd.type === 'LOOP_START') indentLevel++;
            });
        }

        function updateRamUsage() {
            const usage = program.length;
            const max = LEVELS[currentLevelIdx].maxRam;
            const el = document.getElementById('ramUsage');
            el.innerText = usage;
            el.style.color = usage > max ? '#ef4444' : '#818cf8';
        }

        // --- INTERPRETER ---
        function startExecution() {
            if (program.length === 0) return;

            let balance = 0;
            for (let c of program) {
                if (c.type === 'LOOP_START') balance++;
                if (c.type === 'LOOP_END') balance--;
            }
            if (balance !== 0) {
                alert("Syntax Error: Unbalanced Loops (Check REPEAT/END)");
                return;
            }

            resetBotState();

            pc = 0;
            executionStack = [];

            isRunning = true;
            setUIState('running');

            step();
        }

        function stopExecution() {
            isRunning = false;
            resetBotState();
            pc = 0;
            setUIState('idle');
            renderIDE();
            drawGame();
        }

        function resetBotOnly() {
            if (isRunning) stopExecution();
            resetBotState();
            drawGame();
        }

        function step() {
            if (!isRunning) return;
            if (pc >= program.length) {
                checkWin();
                isRunning = false;
                setUIState('idle');
                renderIDE();
                return;
            }

            renderIDE();
            drawGame();

            const cmd = program[pc];

            switch (cmd.type) {
                case 'MOVE':
                    moveBot();
                    pc++;
                    break;
                case 'TURN_LEFT':
                    bot.dir = (bot.dir + 3) % 4;
                    pc++;
                    break;
                case 'TURN_RIGHT':
                    bot.dir = (bot.dir + 1) % 4;
                    pc++;
                    break;
                case 'COLLECT':
                    tryCollect();
                    pc++;
                    break;
                case 'LOOP_START':
                    executionStack.push({
                        startPc: pc,
                        count: cmd.count,
                        currentIter: 1
                    });
                    pc++;
                    break;
                case 'LOOP_END':
                    if (executionStack.length > 0) {
                        const frame = executionStack[executionStack.length - 1];
                        if (frame.currentIter < frame.count) {
                            frame.currentIter++;
                            pc = frame.startPc + 1;
                        } else {
                            executionStack.pop();
                            pc++;
                        }
                    } else {
                        pc++;
                    }
                    break;
            }

            if (isRunning) setTimeout(step, speed);
        }

        function moveBot() {
            let nextX = bot.x;
            let nextY = bot.y;

            if (bot.dir === 0) nextY--;
            if (bot.dir === 1) nextX++;
            if (bot.dir === 2) nextY++;
            if (bot.dir === 3) nextX--;

            const lvl = LEVELS[currentLevelIdx];
            if (nextX < 0 || nextX >= lvl.gridW || nextY < 0 || nextY >= lvl.gridH) return;

            const cell = lvl.map[nextY * lvl.gridW + nextX];
            if (cell === 1) return;

            bot.x = nextX;
            bot.y = nextY;
        }

        function tryCollect() {
            const lvl = LEVELS[currentLevelIdx];
            const cellIdx = bot.y * lvl.gridW + bot.x;
            const cell = lvl.map[cellIdx];

            if (cell === 3 && !isCoreCollected(bot.x, bot.y)) {
                collectedCoords.push({ x: bot.x, y: bot.y });
                coresCollected++;
            }
        }

        function checkWin() {
            if (coresCollected >= totalCores) {
                document.getElementById('successModal').classList.remove('hidden');
            } else {
                alert("Program finished, but data cores missed.");
            }
        }

        window.onload = () => initLevel(0);

        document.querySelectorAll('.cmd-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                addCommand(btn.dataset.cmd);
            });
        });

        document.getElementById('clearBtn').onclick = () => {
            program = [];
            renderIDE();
            updateRamUsage();
        };

        document.getElementById('runBtn').onclick = startExecution;
        document.getElementById('stopBtn').onclick = stopExecution;
        document.getElementById('resetBotBtn').onclick = resetBotOnly;

        document.getElementById('nextLevelBtn').onclick = () => {
            if (currentLevelIdx < LEVELS.length - 1) {
                initLevel(currentLevelIdx + 1);
            } else {
                alert("All protocols optimized! System secure.");
                initLevel(0);
            }
        };

        document.getElementById('jwBtn').onclick = () => window.location.reload();

    </script>
</body>

</html>